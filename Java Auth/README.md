# Java JWT Авторизация (UI Angular) 

Реализация авторизации по **access** и **refresh** токенам с использованием https (публикацией ngrok)

NodeJs `v24.13.1`

Angular `v21.1.4`

Java `v21`

Gradle `v8.12` 

### Настройка проекта

#### Сеть

Backend:

локальный url: `http://localhost:8080`

публичный url: `https://security.cloudpub.ru`

публикация по http, по порту 8080

Frontend: 

локальный url: `http://localhost:4200`

публичный url: `https://angular.cloudpub.ru`

публикация по http, по порту 4200

**Важно:** бекенд и фронтенд должны быть в одном домене (`.cloudpub.ru`)

БД - postgres, в одной сети с Backend локальный url: `http://localhost:5432`

#### БД

название: auth-sharp

созданы таблицы:

```
CREATE TABLE public."Role" (
	"Id" int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"Name" text NULL,
	CONSTRAINT "PK_Role" PRIMARY KEY ("Id")
);


CREATE TABLE public."User" (
	"Id" int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"Name" text NULL,
	"Login" text NULL,
 	"Password" text NULL,
 	"RoleId" int8 NOT NULL,
 	"RefreshTokenHash" text NULL,
 	"RefreshTokenExpiryDate" timestamptz NULL,
 	CONSTRAINT "PK_User" PRIMARY KEY ("Id"),
 	CONSTRAINT "FK_User_Role_RoleId" FOREIGN KEY ("RoleId") REFERENCES public."Role"("Id") ON DELETE RESTRICT
);
```

#### Backend
Все настройки, кроме `claims` в jwt, находятся в `application.properties`

`# for db` - настройки подключения к бд, настроено МСК время, для работы с названиями таблиц переопределена стратегия поиска названий `PascalCaseNamingStrategy` в `utils/hibernate`

`# server` - настройки бекенд сервера (публичный url, его домен, порт)

`# JWT` - секрет и время жизни access и refresh токенов

`# frontend` - адреса фронтенда

`# swagger` - настройки swagger, в том числе открытие страницы при запуске, дополнительно в `utils/swagger`

в JwtProvider (`utils/security`) настроены поля добавляемые в JWT

#### Frontend

публичный url находится в файле:

```
angular.json
"serve": {
          "builder": "@angular/build:dev-server",
          "options": {
            "allowedHosts": \["angular.cloudpub.ru"]
          },

```

Как таковых настроек нет, кроме установленных пакетов в `package.json`
## Механизм работы
#### Backend (`/api/auth`)

Авторизация:

запрос `/login` -> аутентификация -> выдача access token, refresh token. хеш и срок годности refresh токена сохраняется в бд -> выдача данных user с прикрепленными cookie

Обновление токена:

запрос `/refresh` для access токена -> сравнение refresh с сохраненным в бд -> выдача нового access токена в ответе с cookie



Выход из аккаунта:

запрос `/logout` -> выдача cookie с нулевым сроком годности


Проверка токена:

запрос `/check` -> проверка access токена -> выдача ответа 200 или 401

#### Frontend

Навигация:

`app.routes.ts` хранит компоненты все компоненты

изначально переход на `root.component` -> перехват в AuthGuard (пропуск `/login` если `true`) -> `/login` -> `/admin/dashboard` или `/user/dashboard`

AuthGuard и RoleGuard определяет доступ к тому или иному компоненту

Работа с cookie:

`auth-interceptor.ts` добавляет ко всем запросам `withCredentials: true` - прикрепляет куки к каждому запрос. Также отлавливает 401 и выполняет `/refresh`

в models - dto

в services - api

AuthService хранит `currentUserSubject` - состояние пользователя, доступное любому другому компоненту

